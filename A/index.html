<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UR-BERT Multilingual TTS Evaluation</title>
<style>
  :root {
    --bg: #fafafa;
    --card-bg: #ffffff;
    --border: #e0e0e0;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --text: #1a1a1a;
    --text-muted: #666;
    --danger: #dc2626;
    --success: #16a34a;
    --progress-bg: #e5e7eb;
    --roman-bg: #f0f4ff;
    --lang-badge: #eef2ff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    max-width: 860px;
    margin: 0 auto;
    padding: 20px 24px 60px;
  }

  /* â”€â”€â”€ Environment Warning Banner â”€â”€â”€ */
  .env-warning {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 14px 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    font-size: 0.9rem;
    color: #92400e;
  }
  .env-warning .close-btn {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: #92400e;
    padding: 4px 8px;
    flex-shrink: 0;
  }

  /* â”€â”€â”€ Header â”€â”€â”€ */
  .header {
    text-align: center;
    padding: 32px 0 24px;
    border-bottom: 2px solid var(--border);
    margin-bottom: 28px;
  }
  .header h1 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .header .subtitle {
    color: var(--text-muted);
    font-size: 0.95rem;
  }
  .type-badge {
    display: inline-block;
    background: var(--accent);
    color: white;
    font-size: 0.8rem;
    font-weight: 700;
    padding: 2px 10px;
    border-radius: 12px;
    margin-left: 8px;
    vertical-align: middle;
  }

  /* â”€â”€â”€ Progress â”€â”€â”€ */
  .progress-wrap {
    position: sticky;
    top: 0;
    background: var(--bg);
    padding: 12px 0;
    z-index: 100;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  .progress-bar-outer {
    height: 8px;
    background: var(--progress-bg);
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-bar-inner {
    height: 100%;
    background: var(--accent);
    border-radius: 4px;
    transition: width 0.3s ease;
  }
  .progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-top: 6px;
  }

  /* â”€â”€â”€ Sections â”€â”€â”€ */
  .section { margin-bottom: 32px; }
  .section h2 {
    font-size: 1.15rem;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€â”€ Instructions â”€â”€â”€ */
  .instructions {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 28px;
  }
  .instructions p { margin-bottom: 10px; }
  .instructions .scale-table {
    width: 100%;
    border-collapse: collapse;
    margin: 14px 0;
    font-size: 0.92rem;
  }
  .scale-table td, .scale-table th {
    padding: 6px 10px;
    border: 1px solid var(--border);
    text-align: left;
  }
  .scale-table th { background: #f5f5f5; width: 100px; text-align: center; }
  .warning-box {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 6px;
    padding: 12px 16px;
    margin-top: 14px;
    font-size: 0.9rem;
  }

  /* â”€â”€â”€ Evaluator info â”€â”€â”€ */
  .id-section {
    text-align: center;
    padding: 40px 20px;
  }
  .id-section .field-group {
    display: inline-block;
    text-align: left;
    margin-bottom: 18px;
    width: 320px;
  }
  .id-section .field-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 0.95rem;
  }
  .id-section .field-group .optional-tag {
    color: var(--text-muted);
    font-weight: 400;
    font-size: 0.82rem;
  }
  .id-section .field-group .field-hint {
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-top: 4px;
  }
  .id-section input {
    padding: 10px 16px;
    font-size: 1rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }
  .id-section input:focus { border-color: var(--accent); }

  /* â”€â”€â”€ Stimulus card â”€â”€â”€ */
  .stimulus-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 22px 24px;
    margin-bottom: 20px;
    transition: box-shadow 0.2s;
  }
  .stimulus-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
  .stimulus-card .item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }
  .item-number {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--accent);
  }
  .lang-badge {
    display: inline-block;
    background: var(--lang-badge);
    color: var(--accent);
    font-size: 0.78rem;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 12px;
    text-transform: uppercase;
  }

  /* text display */
  .text-block {
    margin-bottom: 14px;
  }
  .original-text {
    font-size: 1.05rem;
    font-weight: 500;
    margin-bottom: 6px;
  }
  .roman-text {
    background: var(--roman-bg);
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 0.92rem;
    color: #4338ca;
    font-style: italic;
    font-family: 'Consolas', 'Menlo', monospace;
  }

  /* audio */
  .audio-wrap {
    margin: 14px 0;
  }
  .audio-wrap audio {
    width: 100%;
    height: 42px;
  }

  /* MOS rating */
  .mos-rating {
    margin-top: 12px;
  }
  .mos-rating .rating-label {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 8px;
    display: block;
  }
  .mos-options {
    display: flex;
    gap: 8px;
  }
  .mos-options label {
    flex: 1;
    text-align: center;
    cursor: pointer;
  }
  .mos-options input[type="radio"] { display: none; }
  .mos-btn {
    display: block;
    padding: 10px 0;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.15s;
    background: var(--card-bg);
  }
  .mos-btn:hover { border-color: var(--accent); background: #f0f4ff; }
  .mos-options input[type="radio"]:checked + .mos-btn {
    border-color: var(--accent);
    background: var(--accent);
    color: white;
  }
  .mos-scale-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 4px;
    padding: 0 4px;
  }

  /* unanswered highlight */
  .stimulus-card.unanswered {
    border-color: var(--danger);
    box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.15);
  }

  /* â”€â”€â”€ Buttons â”€â”€â”€ */
  .btn {
    display: inline-block;
    padding: 12px 36px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-primary {
    background: var(--accent);
    color: white;
  }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-secondary {
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger {
    background: var(--danger);
    color: white;
  }
  .btn-danger:hover { background: #b91c1c; }
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-group {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 28px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }

  /* â”€â”€â”€ Resume banner â”€â”€â”€ */
  .resume-banner {
    background: #ecfdf5;
    border: 1px solid #6ee7b7;
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  .resume-banner p {
    font-size: 0.92rem;
    color: #065f46;
  }

  /* â”€â”€â”€ Submit status â”€â”€â”€ */
  .submit-status {
    margin: 16px 0;
    padding: 14px 18px;
    border-radius: 8px;
    font-size: 0.92rem;
    display: none;
  }
  .submit-status.show { display: block; }
  .submit-status.loading {
    background: #f0f4ff;
    border: 1px solid #bfdbfe;
    color: var(--accent);
  }
  .submit-status.success {
    background: #ecfdf5;
    border: 1px solid #6ee7b7;
    color: #065f46;
  }
  .submit-status.error {
    background: #fef2f2;
    border: 1px solid #fca5a5;
    color: #991b1b;
  }

  /* â”€â”€â”€ Finish â”€â”€â”€ */
  .finish-screen {
    text-align: center;
    padding: 60px 20px;
  }
  .finish-screen h2 {
    font-size: 1.5rem;
    color: var(--success);
    margin-bottom: 12px;
    border: none;
  }

  /* â”€â”€â”€ Responsive â”€â”€â”€ */
  @media (max-width: 600px) {
    body { padding: 12px 14px 40px; }
    .mos-options { gap: 4px; }
    .mos-btn { padding: 8px 0; font-size: 0.85rem; }
    .id-section .field-group { width: 100%; }
  }
</style>
</head>

<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ENVIRONMENT WARNING (mobile)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mobile-warning" class="env-warning" style="display:none;">
  <span>ğŸ“± <b>ëª¨ë°”ì¼ í™˜ê²½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</b> ì •í™•í•œ í‰ê°€ë¥¼ ìœ„í•´ PCì—ì„œ ìœ ì„  í—¤ë“œí°ì„ ì‚¬ìš©í•˜ì—¬ ì ‘ì†í•´ ì£¼ì„¸ìš”.</span>
  <button class="close-btn" onclick="this.parentElement.style.display='none'">âœ•</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 1: Instructions + Evaluator Info
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="phase-intro">

  <div class="header">
    <h1>Multilingual TTS MOS Evaluation <span class="type-badge" id="type-badge"></span></h1>
    <p class="subtitle">UR-BERT Â· Interspeech 2026</p>
  </div>

  <div class="instructions">
    <div class="section">
      <h2>ì‹¤í—˜ ì•ˆë‚´</h2>
      <p>
        ë³¸ ì‹¤í—˜ì€ ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜(TTS) ì‹œìŠ¤í…œì˜ ìŒì„± í’ˆì§ˆì„ í‰ê°€í•˜ëŠ” ì‹¤í—˜ì…ë‹ˆë‹¤.
        ê° ìƒ˜í”Œì— ëŒ€í•´ <b>ì›ë¬¸ í…ìŠ¤íŠ¸</b>ì™€ <b>ë°œìŒ ê°€ì´ë“œ(Roman script)</b>ê°€ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤.
      </p>
      <p>
        ì˜¤ë””ì˜¤ë¥¼ ì²­ì·¨í•œ í›„, ì•„ë˜ í‰ê°€ ê¸°ì¤€ì— ë”°ë¼ <b>1ì ë¶€í„° 5ì ê¹Œì§€ ì ˆëŒ€ì ì¸ ì ìˆ˜</b>ë¥¼ ë¶€ì—¬í•´ ì£¼ì„¸ìš”.
        ê° ìƒ˜í”Œì€ ì„œë¡œ ë¹„êµí•˜ì§€ ë§ê³ , í•´ë‹¹ ìƒ˜í”Œ ìì²´ì˜ í’ˆì§ˆë§Œ í‰ê°€í•´ ì£¼ì„¸ìš”.
      </p>
    </div>

    <div class="section">
      <h2>í‰ê°€ ê¸°ì¤€ (MOS)</h2>
      <table class="scale-table">
        <tr><th>5</th><td><b>Excellent</b> : ìì—°ìŠ¤ëŸ½ê³  ëª…ë£Œí•˜ë©°, ì›ì–´ë¯¼ ìˆ˜ì¤€ì˜ ë°œìŒê³¼ ìš´ìœ¨</td></tr>
        <tr><th>4</th><td><b>Good</b> : ì•½ê°„ ë¶€ìì—°ìŠ¤ëŸ¬ìš´ ë¶€ë¶„ì´ ìˆìœ¼ë‚˜ ì „ë°˜ì ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ì›€</td></tr>
        <tr><th>3</th><td><b>Fair</b> : ë¶€ìì—°ìŠ¤ëŸ¬ìš´ ë¶€ë¶„ì´ ë°˜ë³µì ìœ¼ë¡œ ëŠê»´ì§€ë‚˜ ë‚´ìš© ì´í•´ì—ëŠ” ë¬¸ì œ ì—†ìŒ</td></tr>
        <tr><th>2</th><td><b>Poor</b> : ê¸°ê³„ìŒ/ì™œê³¡ì´ ìì£¼ ë“¤ë¦¬ê³ , ë°œìŒ ì˜¤ë¥˜ê°€ ë§ì•„ ì´í•´í•˜ê¸° ì–´ë ¤ì›€</td></tr>
        <tr><th>1</th><td><b>Bad</b> : ë§¤ìš° ë¶€ìì—°ìŠ¤ëŸ½ê³  ë‚´ìš©ì„ ê±°ì˜ ì´í•´í•  ìˆ˜ ì—†ìŒ</td></tr>
      </table>
    </div>

    <div class="warning-box">
      âš ï¸ <b>ìœ ì˜ì‚¬í•­</b><br>
      Â· ğŸ§ ì¡°ìš©í•œ í™˜ê²½ì—ì„œ <b>ìœ ì„  í—¤ë“œí°</b>ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš” (ë¸”ë£¨íˆ¬ìŠ¤ ì‚¬ìš© ê¸ˆì§€).<br>
      Â· ğŸ–¥ï¸ <b>PC í™˜ê²½</b>ì—ì„œ <b>ì¼ë°˜ ëª¨ë“œ</b>(ì‹œí¬ë¦¿/ì‚¬ìƒí™œ ë³´í˜¸ ëª¨ë“œ X)ë¡œ ì§„í–‰í•´ ì£¼ì„¸ìš”.<br>
      Â· ê° ì˜¤ë””ì˜¤ëŠ” <b>ì „ì²´ë¥¼ ëê¹Œì§€ ì²­ì·¨</b>í•œ í›„ í‰ê°€í•´ ì£¼ì„¸ìš”.<br>
      Â· ì´ <b id="total-count">225</b>ê°œ ìƒ˜í”Œì´ë©°, ì•½ <b>20~30ë¶„</b> ì†Œìš”ë©ë‹ˆë‹¤.<br>
      Â· <b>ì§„í–‰ ìƒí™©ì€ ìë™ìœ¼ë¡œ ì €ì¥</b>ë©ë‹ˆë‹¤. ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ì¬ì ‘ì†í•˜ë©´ ì´ì–´ì„œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
      Â· ì‹¤í—˜ ì™„ë£Œ ì‹œ ê²°ê³¼ê°€ <b>ìë™ìœ¼ë¡œ ì„œë²„ì— ì œì¶œ</b>ë©ë‹ˆë‹¤.
    </div>
  </div>

  <div class="id-section">
    <div class="field-group">
      <label for="evaluator-name">ì´ë¦„ <span style="color:var(--danger);">*</span></label>
      <input type="text" id="evaluator-name" placeholder="ì˜ˆ: í™ê¸¸ë™" autocomplete="name">
    </div>
    <br>
    <div class="field-group">
      <label for="evaluator-contact">ì—°ë½ì²˜ <span class="optional-tag">(ì„ íƒ)</span></label>
      <input type="text" id="evaluator-contact" placeholder="ì˜ˆ: 010-1234-5678" autocomplete="tel">
      <div class="field-hint">ê¸°í”„í‹°ì½˜ ìˆ˜ë ¹ì„ ì›í•˜ì‹œë©´ ì…ë ¥í•´ ì£¼ì„¸ìš”.</div>
      <div class="field-hint">ìˆ˜ì§‘ëœ ê°œì¸ì •ë³´ëŠ” ê¸°í”„í‹°ì½˜ ë°œì†¡ ìš©ë„ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
    </div>
    <br>
    <button class="btn btn-primary" id="start-btn" onclick="startEvaluation()">ì‹œì‘í•˜ê¸°</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 2: Evaluation
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="phase-eval" style="display:none;">

  <div class="header">
    <h1>Multilingual TTS MOS Evaluation <span class="type-badge" id="type-badge-eval"></span></h1>
    <p class="subtitle" id="eval-subtitle"></p>
  </div>

  <div class="progress-wrap" id="progress-wrap">
    <div class="progress-bar-outer">
      <div class="progress-bar-inner" id="progress-bar" style="width:0%"></div>
    </div>
    <div class="progress-text">
      <span id="progress-label">0 / 225</span>
      <span id="page-label">Page 1 / 23</span>
    </div>
  </div>

  <div id="resume-banner" class="resume-banner" style="display:none;">
    <p>ğŸ’¾ ì´ì „ ì§„í–‰ ìƒí™©ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div>
      <button class="btn btn-primary" onclick="resumeEval()">ì´ì–´í•˜ê¸°</button>
      <button class="btn btn-secondary" onclick="restartEval()" style="margin-left:8px;">ì²˜ìŒë¶€í„°</button>
    </div>
  </div>

  <div id="container"></div>

  <div class="btn-group">
    <button class="btn btn-secondary" id="prev-btn" onclick="prevPage()">â† ì´ì „</button>
    <button class="btn btn-primary" id="next-btn" onclick="nextPage()">ë‹¤ìŒ â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PHASE 3: Finish
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="phase-finish" style="display:none;">
  <div class="finish-screen">
    <h2>âœ… ì‹¤í—˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
    <div id="submit-status" class="submit-status"></div>
    <p style="color:var(--danger); font-weight:600; margin-top:16px;">
      âš ï¸ ê²°ê³¼ ì œì¶œì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì´ í™”ë©´ì„ ë‹«ì§€ ë§ì•„ì£¼ì„¸ìš”!
    </p>
    <p style="color:var(--text-muted); margin-top:12px;">
      ì œì¶œ ì™„ë£Œ í›„, ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ CSV ë°±ì—… íŒŒì¼ë„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </p>
    <br>
    <button class="btn btn-secondary" onclick="downloadResults()">CSV ë°±ì—… ë‹¤ìš´ë¡œë“œ</button>
    <p style="margin-top:30px; font-size:1.1rem;">ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ‰</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Config (external) + Logic
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="config.js"></script>
<script>
/********************************************************
 * STATE
 ********************************************************/
let evaluatorName = "";
let evaluatorContact = "";
let trials = [];        // shuffled stimuli
let pageIndex = 0;
let results = {};       // { stimulus_id: { mos: 5, timestamp: "..." } }
const ITEMS_PER_PAGE = EVAL_CONFIG.itemsPerPage || 10;
const STORAGE_KEY = EVAL_CONFIG.storageKey || "urbert_eval_v1";
const EXPERIMENT_TYPE = EVAL_CONFIG.experimentType || "?";

/********************************************************
 * ON LOAD: Setup
 ********************************************************/
(function init() {
  // Type badge
  document.getElementById("type-badge").textContent = "Type " + EXPERIMENT_TYPE;
  document.getElementById("type-badge-eval").textContent = "Type " + EXPERIMENT_TYPE;

  // Total count
  document.getElementById("total-count").textContent = stimuli.length;

  // Mobile detection
  if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    document.getElementById("mobile-warning").style.display = "flex";
  }
})();

/********************************************************
 * SEEDED SHUFFLE (deterministic per evaluator)
 ********************************************************/
function seededRandom(seed) {
  let s = 0;
  for (let i = 0; i < seed.length; i++) {
    s = ((s << 5) - s) + seed.charCodeAt(i);
    s |= 0;
  }
  return function () {
    s ^= s << 13;
    s ^= s >> 17;
    s ^= s << 5;
    return (s >>> 0) / 4294967296;
  };
}

function shuffleWithSeed(array, seed) {
  const rng = seededRandom(seed);
  const arr = array.slice();
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/********************************************************
 * LOCAL STORAGE helpers
 ********************************************************/
function saveState() {
  const state = {
    evaluatorName,
    evaluatorContact,
    trials: trials.map(t => t.id),
    pageIndex,
    results,
    timestamp: new Date().toISOString()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}

function clearState() {
  localStorage.removeItem(STORAGE_KEY);
}

/********************************************************
 * INITIALIZATION
 ********************************************************/
function startEvaluation() {
  evaluatorName = document.getElementById("evaluator-name").value.trim();
  evaluatorContact = document.getElementById("evaluator-contact").value.trim();

  if (!evaluatorName) {
    alert("ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
    document.getElementById("evaluator-name").focus();
    return;
  }

  const saved = loadState();

  // Check if there's a saved session for this evaluator
  if (saved && saved.evaluatorName === evaluatorName && Object.keys(saved.results).length > 0) {
    // Restore trial order
    const idToStimulus = {};
    stimuli.forEach(s => { idToStimulus[s.id] = s; });
    trials = saved.trials.map(id => idToStimulus[id]).filter(Boolean);
    results = saved.results || {};
    pageIndex = saved.pageIndex || 0;
    evaluatorContact = saved.evaluatorContact || evaluatorContact;

    showEvalPhase();
    document.getElementById("resume-banner").style.display = "flex";
    loadPage();
  } else {
    // Fresh start
    trials = shuffleWithSeed(stimuli, evaluatorName);
    results = {};
    pageIndex = 0;

    showEvalPhase();
    loadPage();
    saveState();
  }
}

function resumeEval() {
  document.getElementById("resume-banner").style.display = "none";
}

function restartEval() {
  document.getElementById("resume-banner").style.display = "none";
  trials = shuffleWithSeed(stimuli, evaluatorName);
  results = {};
  pageIndex = 0;
  saveState();
  loadPage();
}

function showEvalPhase() {
  document.getElementById("phase-intro").style.display = "none";
  document.getElementById("phase-eval").style.display = "block";
  document.getElementById("eval-subtitle").textContent = "Evaluator: " + evaluatorName;
}

/********************************************************
 * RENDER PAGE
 ********************************************************/
function loadPage() {
  const container = document.getElementById("container");
  container.innerHTML = "";

  const start = pageIndex * ITEMS_PER_PAGE;
  const current = trials.slice(start, start + ITEMS_PER_PAGE);
  const totalPages = Math.ceil(trials.length / ITEMS_PER_PAGE);

  current.forEach((t, idx) => {
    const globalIdx = start + idx + 1;
    const card = document.createElement("div");
    card.className = "stimulus-card";
    card.id = "card-" + t.id;

    // Check for existing answer
    const existing = results[t.id];
    const checkedVal = existing ? existing.mos : null;

    card.innerHTML =
      '<div class="item-header">' +
        '<span class="item-number">Item ' + globalIdx + ' / ' + trials.length + '</span>' +
        '<span class="lang-badge">' + t.lang + '</span>' +
      '</div>' +
      '<div class="text-block">' +
        '<div class="original-text">' + escapeHtml(t.text) + '</div>' +
        '<div class="roman-text">' + escapeHtml(t.roman) + '</div>' +
      '</div>' +
      '<div class="audio-wrap">' +
        '<audio controls preload="none">' +
          '<source src="' + t.audio + '" type="audio/' + getAudioType(t.audio) + '">' +
          'Your browser does not support the audio element.' +
        '</audio>' +
      '</div>' +
      '<div class="mos-rating">' +
        '<span class="rating-label">Quality (MOS):</span>' +
        '<div class="mos-options">' +
          [1,2,3,4,5].map(function(score) {
            return '<label>' +
              '<input type="radio" name="mos_' + t.id + '" value="' + score + '"' +
                (checkedVal == score ? ' checked' : '') +
                ' onchange="onRate(\'' + t.id + '\', ' + score + ')">' +
              '<span class="mos-btn">' + score + '</span>' +
            '</label>';
          }).join("") +
        '</div>' +
        '<div class="mos-scale-labels">' +
          '<span>Bad</span>' +
          '<span>Poor</span>' +
          '<span>Fair</span>' +
          '<span>Good</span>' +
          '<span>Excellent</span>' +
        '</div>' +
      '</div>';

    container.appendChild(card);
  });

  updateProgress();
  updateButtons();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

/********************************************************
 * RATING HANDLER
 ********************************************************/
function onRate(stimulusId, score) {
  results[stimulusId] = {
    mos: score,
    timestamp: new Date().toISOString()
  };
  // Remove unanswered highlight if present
  var card = document.getElementById("card-" + stimulusId);
  if (card) card.classList.remove("unanswered");
  saveState();
  updateProgress();
}

/********************************************************
 * NAVIGATION
 ********************************************************/
function nextPage() {
  var start = pageIndex * ITEMS_PER_PAGE;
  var current = trials.slice(start, start + ITEMS_PER_PAGE);
  var totalPages = Math.ceil(trials.length / ITEMS_PER_PAGE);

  // Check all items on current page are rated
  var allRated = true;
  for (var i = 0; i < current.length; i++) {
    var t = current[i];
    if (!results[t.id]) {
      allRated = false;
      var card = document.getElementById("card-" + t.id);
      if (card) card.classList.add("unanswered");
    }
  }

  if (!allRated) {
    alert("ì´ í˜ì´ì§€ì˜ ëª¨ë“  í•­ëª©ì„ í‰ê°€í•´ ì£¼ì„¸ìš”.");
    return;
  }

  pageIndex++;
  saveState();

  if (pageIndex >= totalPages) {
    finish();
  } else {
    loadPage();
  }
}

function prevPage() {
  if (pageIndex <= 0) return;
  pageIndex--;
  saveState();
  loadPage();
}

function updateButtons() {
  var totalPages = Math.ceil(trials.length / ITEMS_PER_PAGE);
  document.getElementById("prev-btn").disabled = (pageIndex === 0);

  var nextBtn = document.getElementById("next-btn");
  if (pageIndex >= totalPages - 1) {
    nextBtn.textContent = "ì™„ë£Œ ë° ì œì¶œ âœ“";
  } else {
    nextBtn.textContent = "ë‹¤ìŒ â†’";
  }
}

function updateProgress() {
  var answered = Object.keys(results).length;
  var total = trials.length;
  var pct = total > 0 ? (answered / total * 100) : 0;
  var totalPages = Math.ceil(total / ITEMS_PER_PAGE);

  document.getElementById("progress-bar").style.width = pct + "%";
  document.getElementById("progress-label").textContent = answered + " / " + total;
  document.getElementById("page-label").textContent = "Page " + (pageIndex + 1) + " / " + totalPages;
}

/********************************************************
 * GOOGLE SHEETS SUBMISSION
 ********************************************************/
function submitToGoogleSheets() {
  var idToStimulus = {};
  stimuli.forEach(function(s) { idToStimulus[s.id] = s; });

  var payload = {
    evaluator_name: evaluatorName,
    contact: evaluatorContact,
    experiment_type: EXPERIMENT_TYPE,
    results: trials
      .filter(function(t) { return results[t.id]; })
      .map(function(t) {
        var r = results[t.id];
        var s = idToStimulus[t.id];
        return {
          timestamp: r.timestamp,
          stimulus_id: t.id,
          model: s ? s.model : "",
          lang: s ? s.lang : "",
          mos: r.mos
        };
      })
  };

  return fetch(EVAL_CONFIG.sheetUrl, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  }).then(function() {
    return true;
  }).catch(function(err) {
    console.error("Google Sheets submission error:", err);
    return false;
  });
}

/********************************************************
 * FINISH & DOWNLOAD
 ********************************************************/
function finish() {
  document.getElementById("phase-eval").style.display = "none";
  document.getElementById("phase-finish").style.display = "block";

  // Show loading status
  var statusEl = document.getElementById("submit-status");
  statusEl.className = "submit-status show loading";
  statusEl.innerHTML = "â³ ê²°ê³¼ë¥¼ ì„œë²„ì— ì œì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...";

  // Submit to Google Sheets
  submitToGoogleSheets().then(function(success) {
    if (success) {
      statusEl.className = "submit-status show success";
      statusEl.innerHTML = "âœ… ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!";
    } else {
      statusEl.className = "submit-status show error";
      statusEl.innerHTML = "âš ï¸ ìë™ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ CSV íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì‹¤í—˜ ë‹´ë‹¹ìì—ê²Œ ì „ë‹¬í•´ ì£¼ì„¸ìš”.";
    }

    // Always download CSV as backup
    downloadResults();
    clearState();
  });
}

function downloadResults() {
  var header = "evaluator_name,contact,experiment_type,stimulus_id,model,lang,mos,timestamp\n";
  var idToStimulus = {};
  stimuli.forEach(function(s) { idToStimulus[s.id] = s; });

  var csv = header;
  for (var i = 0; i < trials.length; i++) {
    var t = trials[i];
    var r = results[t.id];
    if (r) {
      var s = idToStimulus[t.id];
      csv += csvQuote(evaluatorName) + "," + csvQuote(evaluatorContact) + "," + EXPERIMENT_TYPE + "," +
             t.id + "," + (s ? s.model : "") + "," + (s ? s.lang : "") + "," +
             r.mos + "," + r.timestamp + "\n";
    }
  }

  // UTF-8 BOMì„ ì¶”ê°€í•˜ì—¬ Excelì—ì„œ í•œê¸€ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ í•¨
  var blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "mos_" + EXPERIMENT_TYPE + "_" + evaluatorName + "_" + new Date().toISOString().slice(0,10) + ".csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/********************************************************
 * UTILITIES
 ********************************************************/
function csvQuote(str) {
  // CSV í•„ë“œì— ì‰¼í‘œ, ë”°ì˜´í‘œ, ì¤„ë°”ê¿ˆì´ ìˆìœ¼ë©´ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
  if (!str) return "";
  if (str.indexOf(",") !== -1 || str.indexOf('"') !== -1 || str.indexOf("\n") !== -1) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

function escapeHtml(str) {
  var div = document.createElement("div");
  div.textContent = str;
  return div.innerHTML;
}

function getAudioType(path) {
  if (path.endsWith(".mp3")) return "mpeg";
  if (path.endsWith(".ogg")) return "ogg";
  if (path.endsWith(".opus")) return "opus";
  return "wav";
}

/********************************************************
 * KEYBOARD SHORTCUT: 1-5 for quick rating
 * (rates the first unanswered item on the page)
 ********************************************************/
/********************************************************
 * DEBUG: ë””ë²„ê¹…ìš© ì „ì²´ ìë™ ì±„ìš°ê¸°
 * ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ debugAutoFill() ì‹¤í–‰í•˜ë©´
 * ëª¨ë“  ë¬¸í•­ì— ëœë¤ ì ìˆ˜ë¥¼ ë„£ê³  ë§ˆì§€ë§‰ í™”ë©´ìœ¼ë¡œ ì´ë™
 ********************************************************/
function debugAutoFill() {
  if (!trials.length) { alert("ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”."); return; }
  for (var i = 0; i < trials.length; i++) {
    results[trials[i].id] = {
      mos: Math.floor(Math.random() * 5) + 1,
      timestamp: new Date().toISOString()
    };
  }
  pageIndex = Math.ceil(trials.length / ITEMS_PER_PAGE);
  saveState();
  finish();
}

document.addEventListener("keydown", function (e) {
  // Only in eval phase
  if (document.getElementById("phase-eval").style.display === "none") return;

  var key = parseInt(e.key);
  if (key >= 1 && key <= 5) {
    var start = pageIndex * ITEMS_PER_PAGE;
    var current = trials.slice(start, start + ITEMS_PER_PAGE);

    // Find first unanswered
    var target = null;
    for (var i = 0; i < current.length; i++) {
      if (!results[current[i].id]) { target = current[i]; break; }
    }
    if (!target) return;

    var radio = document.querySelector('input[name="mos_' + target.id + '"][value="' + key + '"]');
    if (radio) {
      radio.checked = true;
      onRate(target.id, key);
    }
  }
});
</script>

</body>
</html>
